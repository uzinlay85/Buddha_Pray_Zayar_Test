<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ဘုရားဝတ်တက် စစ်ဆေးရန်</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Myanmar:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif Myanmar', sans-serif;
        }
        .grid-cols-16 {
            grid-template-columns: repeat(16, minmax(0, 1fr));
        }
        @media (max-width: 1280px) {
            .grid-cols-16 {
                grid-template-columns: repeat(8, minmax(0, 1fr));
            }
        }
        @media (max-width: 640px) {
            .grid-cols-16 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        #seat-tooltip {
            pointer-events: none;
            white-space: pre-wrap;
            transition: opacity 0.2s;
        }
        .seat.absent {
            background-color: #fee2e2 !important;
            color: #991b1b !important;
            border-color: #fecaca !important;
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
        .seat.on-leave {
            background-color: #fef9c3 !important;
            color: #854d0e !important;
            border-color: #fef08a !important;
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(234, 179, 8, 0.5);
        }
        .seat.empty {
            background-color: #f3f4f6;
            border: 1px dashed #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-screen-2xl mx-auto bg-white rounded-2xl shadow-lg p-6">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ဘုရားဝတ်တက် စစ်ဆေးရေးဇယား</h1>
            <p class="text-gray-600 mt-1">ခုံများကို နှိပ်၍ တက်ရောက်မှု အခြေအနေ ပြောင်းလဲနိုင်ပါသည်။</p>
            <p class="text-xs text-gray-500 mt-2">( ပထမကလစ် = ပျက်ကွက် | ဒုတိယကလစ် = ခွင့်ရှိသူ | တတိယကလစ် = တက်ရောက် )</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-grow">
                <div class="bg-blue-600 text-white text-center py-2 rounded-t-lg font-bold shadow-md">စာချဆရာတော်များနှင့် ကျမ်းပြီးသံဃာတော်များ</div>
                <div id="seating-chart-container" class="p-4 bg-gray-50 border rounded-b-lg overflow-x-auto"></div>
                <div class="mt-4 flex justify-center gap-4">
                    <button id="reset-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        အားလုံးကိုပြန်လည်သတ်မှတ်ရန်
                    </button>
                    <button id="download-csv-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        CSV ဖိုင်အဖြစ်ဒေါင်းလုဒ်လုပ်ရန်
                    </button>
                </div>
            </div>

            <div class="lg:w-1/3 xl:w-1/4 flex-shrink-0 space-y-6">
                <div class="bg-white p-4 rounded-lg shadow-md border h-full">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div>
                            <h2 class="text-xl font-bold text-red-700">ပျက်ကွက်စာရင်း</h2>
                            <p id="current-date-absent" class="text-sm text-gray-500"></p>
                        </div>
                        <button id="copy-absent-button" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-200 mt-1">
                            ကူးယူရန်
                        </button>
                    </div>
                    <ul id="absent-list" class="space-y-2 text-gray-700"></ul>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md border h-full">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div>
                            <h2 class="text-xl font-bold text-yellow-700">ခွင့်ရှိသူစာရင်း</h2>
                            <p id="current-date-leave" class="text-sm text-gray-500"></p>
                        </div>
                        <button id="copy-leave-button" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-200 mt-1">
                            ကူးယူရန်
                        </button>
                    </div>
                    <ul id="on-leave-list" class="space-y-2 text-gray-700"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="seat-tooltip" class="hidden absolute p-2 bg-gray-900 text-white text-sm rounded-md shadow-lg z-50"></div>

    <script>
        // --- DOM Element References ---
        const seatingChartContainer = document.getElementById('seating-chart-container');
        const absentList = document.getElementById('absent-list');
        const onLeaveList = document.getElementById('on-leave-list');
        const resetButton = document.getElementById('reset-button');
        const copyAbsentButton = document.getElementById('copy-absent-button');
        const copyLeaveButton = document.getElementById('copy-leave-button');
        const downloadCsvButton = document.getElementById('download-csv-button');
        const tooltip = document.getElementById('seat-tooltip');
        const currentDateAbsentEl = document.getElementById('current-date-absent');
        const currentDateLeaveEl = document.getElementById('current-date-leave');

        // --- Constants ---
        const TOTAL_ROWS = 15;
        const SEATS_PER_ROW = 16;
        const dormColors = {
            'လှ': 'bg-sky-100 text-sky-800 border-sky-200',
            'သိမ်': 'bg-teal-100 text-teal-800 border-teal-200',
            'ပညာ': 'bg-indigo-100 text-indigo-800 border-indigo-200',
            'အဘိ': 'bg-purple-100 text-purple-800 border-purple-200',
            'ရ': 'bg-rose-100 text-rose-800 border-rose-200',
            'ဋ': 'bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200',
            'ပ': 'bg-pink-100 text-pink-800 border-pink-200',
            'ဓံ': 'bg-lime-100 text-lime-800 border-lime-200',
            'သာ': 'bg-emerald-100 text-emerald-800 border-emerald-200',
            'ဓရ': 'bg-cyan-100 text-cyan-800 border-cyan-200',
            'ဝိ': 'bg-orange-100 text-orange-800 border-orange-200',
            'ရွှေ': 'bg-amber-100 text-amber-800 border-amber-200',
            'မံ': 'bg-slate-200 text-slate-800 border-slate-300',
            'လှိုင်': 'bg-green-100 text-green-800 border-green-200',
            'ကြည်': 'bg-violet-100 text-violet-800 border-violet-200',
            'default': 'bg-gray-200 text-gray-800 border-gray-300'
        };

        // --- State ---
        let studentData = {};

        // --- Utility Functions ---
        async function loadStudentData() {
            try {
                const response = await fetch('students.csv');
                const text = await response.text();
                const lines = text.trim().split('\n').slice(1); // Skip header
                studentData = {};
                lines.forEach(line => {
                    const [key, name] = line.split(',').map(item => item.trim());
                    if (key && name) {
                        studentData[key] = name;
                    }
                });
                createSeatingChart();
                updateAllLists();
            } catch (error) {
                console.error('Error loading CSV:', error);
                alert('စတူဒင့်ဒေတာဖိုင်ကို ဖတ်ယူရာတွင် အမှားအယွင်းဖြစ်ပွားသည်။');
            }
        }

        function getBurmeseDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const day = today.getDate();
            const burmeseMonths = ["ဇန်နဝါရီ", "ဖေဖော်ဝါရီ", "မတ်", "ဧပြီ", "မေ", "ဇွန်", "ဇူလိုင်", "ဩဂုတ်", "စက်တင်ဘာ", "အောက်တိုဘာ", "နိုဝင်ဘာ", "ဒီဇင်ဘာ"];
            const burmeseNumerals = ["၀", "၁", "၂", "၃", "၄", "၅", "၆", "၇", "၈", "၉"];
            const toBurmeseNumeral = (num) => String(num).split('').map(digit => burmeseNumerals[parseInt(digit)]).join('');
            return `${burmeseMonths[month]}လ ${toBurmeseNumeral(day)} ရက်၊ ${toBurmeseNumeral(year)}`;
        }

        // --- UI Generation Functions ---
        function createSeatingChart() {
            seatingChartContainer.innerHTML = '';
            seatingChartContainer.classList.add('space-y-4');

            for (let row = 1; row <= TOTAL_ROWS; row++) {
                if (row === 1) continue;

                const rowContainer = document.createElement('div');
                const rowLabel = document.createElement('div');
                rowLabel.classList.add('font-bold', 'text-gray-700', 'mb-2', 'text-lg');
                rowLabel.textContent = `အတန်း - ${row}`;
                rowContainer.appendChild(rowLabel);

                const rowGrid = document.createElement('div');
                rowGrid.classList.add('grid', 'grid-cols-16', 'gap-2');

                for (let seat = 1; seat <= SEATS_PER_ROW; seat++) {
                    const key = `${row}-${seat}`;
                    const studentName = studentData[key] || '';
                    const seatElement = document.createElement('div');
                    seatElement.classList.add('seat', 'h-24', 'flex', 'flex-col', 'items-center', 'justify-center', 'rounded-md', 'p-1', 'transition-all', 'duration-200', 'ease-in-out', 'text-center', 'border');
                    seatElement.dataset.row = row;
                    seatElement.dataset.seat = seat;

                    if (studentName) {
                        const displayName = studentName.split('\n')[0];
                        const dormMatch = studentName.match(/\((.*?)\)/);
                        const dormName = dormMatch ? dormMatch[1] : null;
                        const dormText = dormName ? `(${dormName})` : '';
                        const colorClasses = (dormName ? (dormColors[dormName] || dormColors.default) : dormColors.default).split(' ');

                        seatElement.innerHTML = `<span class="font-bold text-sm">${seat}</span><span class="text-[10px] leading-tight mt-1">${displayName}</span><span class="text-[9px] leading-tight text-gray-500 mt-1">${dormText}</span>`;
                        seatElement.classList.add(...colorClasses, 'cursor-pointer', 'transform', 'hover:scale-110');
                        seatElement.dataset.name = studentName;
                        seatElement.addEventListener('click', cycleAttendanceState);
                        seatElement.addEventListener('mouseover', showTooltip);
                        seatElement.addEventListener('mouseout', hideTooltip);
                        seatElement.addEventListener('mousemove', moveTooltip);
                    } else {
                        seatElement.classList.add('empty');
                        seatElement.innerHTML = `<span class="font-bold text-sm">${seat}</span>`;
                    }
                    rowGrid.appendChild(seatElement);
                }
                rowContainer.appendChild(rowGrid);
                seatingChartContainer.appendChild(rowContainer);
            }
        }

        // --- Attendance Management ---
        function cycleAttendanceState(event) {
            const seat = event.currentTarget;
            if (seat.classList.contains('absent')) {
                seat.classList.remove('absent');
                seat.classList.add('on-leave');
            } else if (seat.classList.contains('on-leave')) {
                seat.classList.remove('on-leave');
            } else {
                seat.classList.add('absent');
            }
            updateAllLists();
        }

        function updateAllLists() {
            updateList('absent', absentList, copyAbsentButton);
            updateList('on-leave', onLeaveList, copyLeaveButton);
        }

        function updateList(state, listElement, buttonElement) {
            listElement.innerHTML = '';
            const seats = document.querySelectorAll(`.seat.${state}`);
            const stateMessages = {
                'absent': 'ပျက်ကွက်သူ မရှိပါ။',
                'on-leave': 'ခွင့်ရှိသူ မရှိပါ။'
            };
            const itemColors = {
                'absent': 'bg-red-50 text-red-800',
                'on-leave': 'bg-yellow-50 text-yellow-800'
            };

            if (seats.length === 0) {
                listElement.innerHTML = `<li class="text-gray-500">${stateMessages[state]}</li>`;
                buttonElement.disabled = true;
                buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                seats.forEach(seat => {
                    const listItem = document.createElement('li');
                    listItem.className = `p-2 rounded-md text-sm ${itemColors[state]}`;
                    const row = seat.dataset.row;
                    const seatNum = seat.dataset.seat;
                    const studentName = (seat.dataset.name || '').replace(/\n/g, ' ');
                    listItem.textContent = `အတန်း ${row}၊ ခုံ ${seatNum}: ${studentName}`;
                    listElement.appendChild(listItem);
                });
            }
        }

        function resetAllSeats() {
            const allSeats = document.querySelectorAll('.seat');
            allSeats.forEach(seat => {
                if (seat.dataset.name) {
                    seat.classList.remove('absent', 'on-leave');
                }
            });
            updateAllLists();
        }

        // --- Copy and Download Functions ---
        function copyList(state, buttonElement) {
            const seats = document.querySelectorAll(`.seat.${state}`);
            if (seats.length === 0) return;

            const dateString = getBurmeseDate();
            const title = state === 'absent' ? 'ပျက်ကွက်စာရင်း' : 'ခွင့်ရှိသူစာရင်း';
            let listText = `${title} (${dateString}):\n\n`;
            seats.forEach(seat => {
                const row = seat.dataset.row;
                const seatNum = seat.dataset.seat;
                const studentName = (seat.dataset.name || '').replace(/\n/g, ' ');
                listText += `အတန်း ${row}၊ ခုံ ${seatNum}: ${studentName}\n`;
            });

            const textArea = document.createElement("textarea");
            textArea.value = listText.trim();
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                const originalText = buttonElement.textContent;
                const originalClasses = buttonElement.className;
                buttonElement.textContent = 'ကူးယူပြီးပါပြီ!';
                buttonElement.className = buttonElement.className.replace(/bg-(red|yellow)-500\shover:bg-(red|yellow)-600/, 'bg-blue-500');
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.className = originalClasses;
                }, 2000);
            } catch (err) {
                console.error('ကူးယူရာတွင် အမှားအယွင်းဖြစ်ပွားသည်: ', err);
            }
            document.body.removeChild(textArea);
        }

        function downloadAttendanceCSV() {
            const dateString = getBurmeseDate();
            let csvContent = "Row,Seat,Name,Status\n";
            const allSeats = document.querySelectorAll('.seat');
            allSeats.forEach(seat => {
                if (seat.dataset.name) {
                    const row = seat.dataset.row;
                    const seatNum = seat.dataset.seat;
                    const studentName = (seat.dataset.name || '').replace(/\n/g, ' ').replace(/,/g, ' ');
                    const status = seat.classList.contains('absent') ? 'ပျက်ကွက်' : seat.classList.contains('on-leave') ? 'ခွင့်ရှိသူ' : 'တက်ရောက်';
                    csvContent += `${row},${seatNum},${studentName},${status}\n`;
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `attendance_${dateString}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function showTooltip(event) {
            const seat = event.currentTarget;
            const studentName = seat.dataset.name;
            if (studentName) {
                tooltip.textContent = studentName;
                tooltip.classList.remove('hidden');
            }
        }

        function hideTooltip() {
            tooltip.classList.add('hidden');
        }

        function moveTooltip(event) {
            tooltip.style.left = `${event.pageX + 15}px`;
            tooltip.style.top = `${event.pageY + 15}px`;
        }

        // --- Event Listeners ---
        resetButton.addEventListener('click', resetAllSeats);
        copyAbsentButton.addEventListener('click', () => copyList('absent', copyAbsentButton));
        copyLeaveButton.addEventListener('click', () => copyList('on-leave', copyLeaveButton));
        downloadCsvButton.addEventListener('click', downloadAttendanceCSV);

        // --- Initial Load ---
        loadStudentData();
        const todayDate = getBurmeseDate();
        currentDateAbsentEl.textContent = todayDate;
        currentDateLeaveEl.textContent = todayDate;
    </script>
</body>
</html>