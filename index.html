<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ဘုရားဝတ်တက် စစ်ဆေးရန်</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Pyidaungsu', sans-serif;
        }
        .grid-cols-dynamic {
            display: grid;
            gap: 0.5rem;
            /* Default for larger screens, 12 columns */
            grid-template-columns: repeat(12, minmax(0, 1fr));
        }
        /* For tablets */
        @media (max-width: 1280px) {
            .grid-cols-dynamic {
                grid-template-columns: repeat(8, minmax(0, 1fr));
            }
        }
        /* For mobile phones */
        @media (max-width: 640px) {
            .grid-cols-dynamic {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        #seat-tooltip {
            pointer-events: none;
            white-space: pre-wrap;
            transition: opacity 0.2s;
        }
        .seat.absent {
            border: 3px solid #ef4444 !important; /* red-500 */
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
        .seat.on-leave {
            border: 3px solid #eab308 !important; /* yellow-500 */
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(234, 179, 8, 0.5);
        }
        .seat.empty {
            background-color: #f3f4f6;
            border: 1px dashed #d1d5db;
        }
        .list-container {
            min-height: 100px; /* Minimum height when empty */
            transition: height 0.3s ease; /* Smooth height transition */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-screen-2xl mx-auto bg-white rounded-2xl shadow-lg p-6">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ဘုရားဝတ်တက် စစ်ဆေးရေးဇယား</h1>
            <p class="text-gray-600 mt-1">ခုံများကို နှိပ်၍ တက်ရောက်မှု အခြေအနေ ပြောင်းလဲနိုင်ပါသည်။</p>
            <p class="text-xs text-gray-500 mt-2">( ပထမကလစ် = ပျက်ကွက် | ဒုတိယကလစ် = ခွင့်ရှိသူ | တတိယကလစ် = တက်ရောက် )</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-grow">
                <div class="bg-blue-600 text-white text-center py-2 rounded-t-lg font-bold shadow-md">စာချဆရာတော်များနှင့် ကျမ်းပြီးသံဃာတော်များ</div>
                <div id="seating-chart-container" class="p-4 bg-gray-50 border rounded-b-lg overflow-x-auto"></div>
                <div class="mt-4 flex justify-center">
                    <button id="reset-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        အားလုံးကိုပြန်လည်သတ်မှတ်ရန်
                    </button>
                </div>
            </div>

            <div class="lg:w-1/3 xl:w-1/4 flex-shrink-0 space-y-6">
                <div class="bg-white p-4 rounded-lg shadow-md border list-container">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div>
                            <h2 class="text-xl font-bold text-red-700">ပျက်ကွက်စာရင်း</h2>
                            <p id="current-date-absent" class="text-sm text-gray-500"></p>
                        </div>
                        <button id="copy-absent-button" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-200 mt-1">
                            ကူးယူရန်
                        </button>
                    </div>
                    <ul id="absent-list" class="space-y-2 text-gray-700"></ul>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md border list-container">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div>
                            <h2 class="text-xl font-bold text-yellow-700">ခွင့်ရှိသူစာရင်း</h2>
                            <p id="current-date-leave" class="text-sm text-gray-500"></p>
                        </div>
                        <button id="copy-leave-button" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-200 mt-1">
                            ကူးယူရန်
                        </button>
                    </div>
                    <ul id="on-leave-list" class="space-y-2 text-gray-700"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="seat-tooltip" class="hidden absolute p-2 bg-gray-900 text-white text-sm rounded-md shadow-lg z-50"></div>

    <script>
        // --- DOM Element References ---
        const seatingChartContainer = document.getElementById('seating-chart-container');
        const absentList = document.getElementById('absent-list');
        const onLeaveList = document.getElementById('on-leave-list');
        const resetButton = document.getElementById('reset-button');
        const copyAbsentButton = document.getElementById('copy-absent-button');
        const copyLeaveButton = document.getElementById('copy-leave-button');
        const tooltip = document.getElementById('seat-tooltip');
        const currentDateAbsentEl = document.getElementById('current-date-absent');
        const currentDateLeaveEl = document.getElementById('current-date-leave');

        // --- Constants ---
        const dormColors = {
            'လှ': 'bg-sky-100 text-sky-800 border-sky-200',
            'သိမ်': 'bg-teal-100 text-teal-800 border-teal-200',
            'ပညာ': 'bg-indigo-100 text-indigo-800 border-indigo-200',
            'အဘိ': 'bg-purple-100 text-purple-800 border-purple-200',
            'ရ': 'bg-rose-100 text-rose-800 border-rose-200',
            'ဋ': 'bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200',
            'ပ': 'bg-pink-100 text-pink-800 border-pink-200',
            'ဓံ': 'bg-lime-100 text-lime-800 border-lime-200',
            'သာ': 'bg-emerald-100 text-emerald-800 border-emerald-200',
            'ဓရ': 'bg-cyan-100 text-cyan-800 border-cyan-200',
            'ဝိ': 'bg-orange-100 text-orange-800 border-orange-200',
            'ရွှေ': 'bg-amber-100 text-amber-800 border-amber-200',
            'မံ': 'bg-slate-200 text-slate-800 border-slate-300',
            'လှိုင်': 'bg-green-100 text-green-800 border-green-200',
            'ကြည်': 'bg-violet-100 text-violet-800 border-violet-200',
            'default': 'bg-gray-200 text-gray-800 border-gray-300'
        };

        // --- State ---
        let studentData = {}; // Will be indexed by C_Num

        // --- Utility Functions ---
        async function loadStudentData() {
            try {
                const response = await fetch('students.csv');
                const text = await response.text();
                const lines = text.trim().split('\n').slice(1); // Skip header
                studentData = {};
                
                lines.forEach(line => {
                    const columns = line.split(',');
                    const name = columns[2]?.trim();
                    const school = columns[4]?.trim();
                    const c_num_str = columns[5]?.trim();

                    if (c_num_str && name) {
                        const c_num = parseInt(c_num_str, 10);
                        if (!isNaN(c_num)) {
                            const fullDormName = school || '';
                            const dormParts = fullDormName.split('-');
                            const dormCode = dormParts.length > 1 ? dormParts[1] : 'default';

                            studentData[c_num] = {
                                name: name,
                                school: fullDormName,
                                dormCode: dormCode,
                                fullName: `${name} (${fullDormName})`
                            };
                        }
                    }
                });

                createSeatingChart();
                updateAllLists();
            } catch (error) {
                console.error('Error loading CSV:', error);
                seatingChartContainer.innerHTML = '<p class="text-red-500 text-center">ကျောင်းသားစာရင်းဖိုင်ကို ဖတ်ရာတွင် အမှားအယွင်းဖြစ်ပွားပါသည်။</p>';
            }
        }

        function getBurmeseDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const day = today.getDate();
            const burmeseMonths = ["ဇန်နဝါရီ", "ဖေဖော်ဝါရီ", "မတ်", "ဧပြီ", "မေ", "ဇွန်", "ဇူလိုင်", "ဩဂုတ်", "စက်တင်ဘာ", "အောက်တိုဘာ", "နိုဝင်ဘာ", "ဒီဇင်ဘာ"];
            const burmeseNumerals = ["၀", "၁", "၂", "၃", "၄", "၅", "၆", "၇", "၈", "၉"];
            const toBurmeseNumeral = (num) => String(num).split('').map(digit => burmeseNumerals[parseInt(digit)]).join('');
            return `${burmeseMonths[month]}လ ${toBurmeseNumeral(day)} ရက်၊ ${toBurmeseNumeral(year)}`;
        }

        // --- UI Generation Functions ---
        function createSeatingChart() {
            seatingChartContainer.innerHTML = '';
            seatingChartContainer.classList.add('space-y-4');

            const SEATS_PER_ROW = 12;
            const seatNumbers = Object.keys(studentData).map(Number);
            if (seatNumbers.length === 0) {
                 seatingChartContainer.innerHTML = '<p class="text-gray-500 text-center">ခုံနံပါတ်ပါသော ကျောင်းသားဒေတာ မရှိပါ။</p>';
                 return;
            }

            const maxSeatNum = Math.max(...seatNumbers);
            const TOTAL_ROWS = Math.ceil(maxSeatNum / SEATS_PER_ROW);

            for (let row = 1; row <= TOTAL_ROWS; row++) {
                const rowContainer = document.createElement('div');
                const rowLabel = document.createElement('div');
                rowLabel.classList.add('font-bold', 'text-gray-700', 'mb-2', 'text-lg');
                rowLabel.textContent = `အတန်း - ${row}`;
                rowContainer.appendChild(rowLabel);

                const rowGrid = document.createElement('div');
                rowGrid.classList.add('grid', 'grid-cols-dynamic');

                for (let seatInRow = 1; seatInRow <= SEATS_PER_ROW; seatInRow++) {
                    const seatNum = (row - 1) * SEATS_PER_ROW + seatInRow;
                    
                    // Don't create seat elements beyond the maximum seat number found in the data
                    if (seatNum > maxSeatNum) {
                        const emptySeatElement = document.createElement('div');
                        emptySeatElement.classList.add('seat', 'empty', 'opacity-0'); // Make it invisible but take up space
                        rowGrid.appendChild(emptySeatElement);
                        continue;
                    }

                    const student = studentData[seatNum];
                    const seatElement = document.createElement('div');
                    seatElement.classList.add('seat', 'h-24', 'flex', 'flex-col', 'items-center', 'justify-center', 'rounded-md', 'p-1', 'transition-all', 'duration-200', 'ease-in-out', 'text-center', 'border');
                    seatElement.dataset.seatNum = seatNum;

                    if (student) {
                        const colorClasses = (dormColors[student.dormCode] || dormColors.default).split(' ');
                        seatElement.innerHTML = `<span class="font-bold text-sm">${seatNum}</span><span class="text-[10px] leading-tight mt-1">${student.name}</span><span class="text-[9px] leading-tight text-gray-500 mt-1">(${student.school})</span>`;
                        seatElement.classList.add(...colorClasses, 'cursor-pointer', 'transform', 'hover:scale-110');
                        seatElement.dataset.name = student.fullName;
                        seatElement.addEventListener('click', cycleAttendanceState);
                        seatElement.addEventListener('mouseover', showTooltip);
                        seatElement.addEventListener('mouseout', hideTooltip);
                        seatElement.addEventListener('mousemove', moveTooltip);
                    } else {
                        seatElement.classList.add('empty');
                        seatElement.innerHTML = `<span class="font-bold text-sm text-gray-400">${seatNum}</span>`;
                    }
                    rowGrid.appendChild(seatElement);
                }
                rowContainer.appendChild(rowGrid);
                seatingChartContainer.appendChild(rowContainer);
            }
        }

        // --- Attendance Management ---
        function cycleAttendanceState(event) {
            const seat = event.currentTarget;
            if (seat.classList.contains('absent')) {
                seat.classList.remove('absent');
                seat.classList.add('on-leave');
            } else if (seat.classList.contains('on-leave')) {
                seat.classList.remove('on-leave');
            } else {
                seat.classList.add('absent');
            }
            updateAllLists();
        }

        function updateAllLists() {
            updateList('absent', absentList, copyAbsentButton);
            updateList('on-leave', onLeaveList, copyLeaveButton);
        }

        function updateList(state, listElement, buttonElement) {
            listElement.innerHTML = '';
            const seats = document.querySelectorAll(`.seat.${state}`);
            const stateMessages = {
                'absent': 'ပျက်ကွက်သူ မရှိပါ။',
                'on-leave': 'ခွင့်ရှိသူ မရှိပါ။'
            };
            const itemColors = {
                'absent': 'bg-red-50 text-red-800',
                'on-leave': 'bg-yellow-50 text-yellow-800'
            };

            if (seats.length === 0) {
                listElement.innerHTML = `<li class="text-gray-500">${stateMessages[state]}</li>`;
                buttonElement.disabled = true;
                buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                const sortedSeats = Array.from(seats).sort((a, b) => {
                    return parseInt(a.dataset.seatNum, 10) - parseInt(b.dataset.seatNum, 10);
                });

                sortedSeats.forEach(seat => {
                    const listItem = document.createElement('li');
                    listItem.className = `p-2 rounded-md text-sm ${itemColors[state]}`;
                    const seatNum = seat.dataset.seatNum;
                    const studentName = seat.dataset.name || '';
                    listItem.textContent = `ခုံ ${seatNum}: ${studentName}`;
                    listElement.appendChild(listItem);
                });
            }
        }

        function resetAllSeats() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="p-8 border w-96 shadow-lg rounded-md bg-white">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900">အတည်ပြုပါ</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-lg text-gray-500">တက်ရောက်မှုအားလုံးကို ပြန်လည်သတ်မှတ်ရန် သေချာပါသလား။</p>
                        </div>
                        <div class="flex justify-center mt-4">
                            <button id="confirm-reset" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">အတည်ပြုသည်</button>
                            <button id="cancel-reset" class="ml-4 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">မပြုလုပ်ပါ</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('confirm-reset').addEventListener('click', () => {
                const allSeats = document.querySelectorAll('.seat');
                allSeats.forEach(seat => {
                    if (seat.dataset.name) {
                        seat.classList.remove('absent', 'on-leave');
                    }
                });
                updateAllLists();
                document.body.removeChild(modal);
            });

            document.getElementById('cancel-reset').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }


        // --- Copy Functions ---
        function copyList(state, buttonElement) {
            const listItems = state === 'absent' ? absentList.querySelectorAll('li') : onLeaveList.querySelectorAll('li');
            if (listItems.length === 0 || (listItems.length === 1 && listItems[0].classList.contains('text-gray-500'))) return;

            const dateString = getBurmeseDate();
            const title = state === 'absent' ? 'ဘုရားဝတ်တက် ပျက်ကွက်စာရင်း' : 'ဘုရားဝတ်တက် ခွင့်ရှိသူစာရင်း';
            let listText = `${title}\n(${dateString})\n\n`;
            
            listItems.forEach(item => {
                listText += `${item.textContent}\n`;
            });

            const textArea = document.createElement("textarea");
            textArea.value = listText.trim();
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                const originalText = buttonElement.textContent;
                const originalClasses = buttonElement.className;
                buttonElement.textContent = 'ကူးယူပြီးပါပြီ!';
                buttonElement.className = buttonElement.className.replace(/bg-(red|yellow)-500\shover:bg-(red|yellow)-600/, 'bg-blue-500');
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.className = originalClasses;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
            document.body.removeChild(textArea);
        }

        function showTooltip(event) {
            const seat = event.currentTarget;
            const studentName = seat.dataset.name;
            if (studentName) {
                tooltip.textContent = studentName;
                tooltip.classList.remove('hidden');
            }
        }

        function hideTooltip() {
            tooltip.classList.add('hidden');
        }

        function moveTooltip(event) {
            tooltip.style.left = `${event.pageX + 15}px`;
            tooltip.style.top = `${event.pageY + 15}px`;
        }

        // --- Event Listeners ---
        resetButton.addEventListener('click', resetAllSeats);
        copyAbsentButton.addEventListener('click', () => copyList('absent', copyAbsentButton));
        copyLeaveButton.addEventListener('click', () => copyList('on-leave', copyLeaveButton));

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStudentData();
            const todayDate = getBurmeseDate();
            currentDateAbsentEl.textContent = todayDate;
            currentDateLeaveEl.textContent = todayDate;
        });
    </script>
</body>
</html>
